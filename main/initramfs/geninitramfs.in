#!/bin/bash

if [ -f /etc/initramfs.conf ]; then
	. /etc/initramfs.conf
	if [ -z "$DEFAULT_KERNEL" ]; then
		DEFAULT_KERNEL=cromnix
	fi
else
	DEFAULT_KERNEL=cromnix
fi

cd /boot
prev_line=""
while read line; do
	line=${line/usr\/lib\/modules\//}
	line=${line%%\/*}
	if [ ! "${prev_line}" = "${line}" ]; then
		prev_line=${line}
		if [ -d /usr/lib/modules/${line} ]; then
			mkinitramfs ${line}
			kernel_name=${line#*-[0-9]*-}
			echo "Renaming to /boot/initramfs-${line}..."
			mv initrd.img-${line} initramfs-${line}.img
			if [ "${kernel_name}" == "${DEFAULT_KERNEL}" ]; then 
				ln -svf initramfs-${line}.img initramfs.img
			fi
		else
			echo "Removing /boot/initramfs-${line}..."
			file=$(file initramfs.img | awk '{print $5}')
			if [ "${file}" == "initramfs-${line}.img" ]; then
				rm initramfs.img
			fi
			rm initramfs-${line}.img
		fi
	fi
done < "${1:-/dev/stdin}"

#if [ -f "/boot/initramfs-${DEFAULT_KERNEL}.img" ]; then
#	ln -sf initramfs-*-${DEFAULT_KERNEL}.img initramfs.img
#else
#	if [ -h initramfs.img ]; then
#		rm initramfs.img
#	fi
#fi
